<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Conformation Inference</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 40px auto; }
    .drop { border: 2px dashed #aaa; padding: 40px; text-align: center; border-radius: 12px; }
    .drop.drag { border-color: #333; }
    .row { margin-top: 20px; }
    .muted { color: #666; }
    video, img { max-width: 100%; border-radius: 12px; margin-top: 10px; }
    .score { font-size: 28px; font-weight: 700; }
  </style>
</head>
<body>
  <h1>Conformation App</h1>
  <div id="drop" class="drop">
    <div><b>Drag & drop</b> an image here</div>
    <div class="muted">or click to choose a file</div>
    <input id="file" type="file" accept="image/*" style="display:none" />
  </div>

  <div class="row">
    <div id="status" class="muted">Idle.</div>
  </div>

  <div class="row">
    <div id="score" class="score"></div>
    <div id="media"></div>
  </div>

<script>
const drop = document.getElementById("drop");
const fileInput = document.getElementById("file");
const statusEl = document.getElementById("status");
const scoreEl = document.getElementById("score");
const mediaEl = document.getElementById("media");

drop.addEventListener("click", () => fileInput.click());

drop.addEventListener("dragover", (e) => {
  e.preventDefault();
  drop.classList.add("drag");
});
drop.addEventListener("dragleave", () => drop.classList.remove("drag"));
drop.addEventListener("drop", (e) => {
  e.preventDefault();
  drop.classList.remove("drag");
  const f = e.dataTransfer.files?.[0];
  if (f) runInfer(f);
});

fileInput.addEventListener("change", () => {
  const f = fileInput.files?.[0];
  if (f) runInfer(f);
});

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

async function runInfer(file) {
  scoreEl.textContent = "";
  mediaEl.innerHTML = "";
  statusEl.textContent = "Uploadingâ€¦";

  const form = new FormData();
  form.append("file", file);

  const resp = await fetch("/infer", { method: "POST", body: form });
  if (!resp.ok) {
    statusEl.textContent = `Upload failed (${resp.status}).`;
    return;
  }
  const { run_id } = await resp.json();
  statusEl.textContent = `Queued. run_id=${run_id}`;

  // Poll
  const start = Date.now();
  while (true) {
    const r = await fetch(`/runs/${run_id}`);
    if (!r.ok) {
      statusEl.textContent = `Polling failed (${r.status}).`;
      return;
    }
    const data = await r.json();
    const st = data.run?.status || "unknown";
    statusEl.textContent = `Status: ${st}`;

    if (st === "failed") {
      statusEl.textContent = `Failed: ${data.run?.error_message || "unknown error"}`;
      return;
    }
    if (st === "succeeded") {
      scoreEl.textContent = `Score: ${data.score ?? "n/a"}`;

      const art = (data.artifacts || [])[0];
      if (art?.signed_url) {
        // If mp4 -> video, else -> img
        if ((art.path || "").toLowerCase().endsWith(".mp4")) {
          mediaEl.innerHTML = `<video controls src="${art.signed_url}"></video>`;
        } else {
          mediaEl.innerHTML = `<img src="${art.signed_url}" />`;
        }
      } else {
        mediaEl.textContent = "No artifact URL found.";
      }
      return;
    }

    if (Date.now() - start > 120000) { // 2 minutes
      statusEl.textContent = "Timed out waiting for run.";
      return;
    }
    await sleep(1200);
  }
}
</script>
</body>
</html>